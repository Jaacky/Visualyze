<!DOCTYPE html>  
<html lang="en">  
    <head>
        <%- include('partials/header.ejs') %>
        <script src="/js/dataset.js"></script>
        <script src="/js/graph.js"></script>
    </head>
    <script>
        var fusion = <%- JSON.stringify(fusion) %>;
        var userGraphs = <%- JSON.stringify(userGraphs) %>;
        var user = <%- JSON.stringify(user) %>;
        console.log(user);
        console.log(fusion);
        <% var includedGraphs = fusion.graphs.map(function(g) { return g.id; }); %>
        var ds = new FusionDataset(fusion);
    </script>
    <body>
        <%- include('partials/nav.ejs') %>
        <div class="mask"></div>
        <div class="container container-fluid main">
            <div class="row">
                <div class="col-md-12 plot-header">
                    <div class="name"><%= fusion.name %></div>
                    <div class="buttons">
                        <div class="action">
                            <button id="add-fusion-graph">
                                <span class="glyphicon glyphicon-plus"></span><span> Graph</span>
                            </button>
                        </div>
                        <div class="action">
                            <button id="invite-fusion">
                                <span class="glyphicon glyphicon-user"></span><span> Invite friend</span>
                            </button>
                        </div>
                        <div class="action">
                            <button id="delete-graph">
                                <span class="glyphicon glyphicon-remove"></span><span> Delete</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="graph-time-options" class="col-md-12 options-group">
                    <button class="btn btn-graph-time">Year</button><button class="btn btn-graph-time active">Month</button><button class="btn btn-graph-time">Week</button>
                </div>
                <div class="date">
                    <button id="backward" class="btn btn-default">&lt;</button>
                    <h3 id="date">Sunday duh</h3>
                    <button id="forward" class="btn btn-default">&gt;</button>
                </div>
                <div class="col-sm-offset-1 col-sm-8">
                    <div id="graph-container"></div>
                </div>
                <div class="col-sm-2">
                    <div class="row">
                        <h4>Selected point:</h4>
                        <div id="tooltip" class="col-sm-12">
                            None
                        </div>
                    </div>
                    <div class="row included-graphs">
                        <h4>Graphs:</h4>
                        <% for (var i=0; i<fusion.graphs.length; i++) { %>
                            <form action="/fusion/removeGraph" method="post" class="description-action">
                                <div class="description"><%= fusion.graphs[i].owner %> / <%= fusion.graphs[i].name %></div>
                                <% if (fusion.graphs[i].owner == user.email) { %>
                                    <input type="text" name="fusion_id" value="<%= fusion.id %>" required hidden>
                                    <input type="text" name="graph_id" value="<%= fusion.graphs[i].id %>" required hidden>
                                    <div class="action"><button>Remove</button></div>
                                <% } %>
                            </form>
                        <% } %>
                    </div>
                </div>
            </div>
        </div> <!-- end container-fluid -->


        <div id="add-graph-form" class="mask-overlay">
            <h4 class="form-title">Add Graphs</h4>
            <button class="remove-mask-overlay" type="button"><span class="glyphicon glyphicon-remove"></span></button>
            <form action="/fusion/add" method="post">
                <div class="form-group">
                    <select name="graphs_added[]" id="graphs_added" class="form-control" multiple>
                        <% for (var j=0; j<userGraphs.length; j++) { %>
                            <% if (includedGraphs.indexOf(userGraphs[j].id) == -1) { %> 
                                <option value="<%= userGraphs[j].id %>"><%= userGraphs[j].name %></option>
                            <% } %>
                        <% } %>
                    </select>
                </div>
                <input name="fusion_id" type="text" value="<%= fusion.id %>" hidden required>
                <button class="btn btn-default" type="submit">Add</button>
            </form>
        </div>

        <div id="invite-friend-form" class="mask-overlay">
            <h4 class="form-title">Invite Friends</h4>
            <button class="remove-mask-overlay" type="button"><span class="glyphicon glyphicon-remove"></span></button>
            <form action="/fusion/invite" method="post">
                <div class="form-group">
                    <select name="invitees[]" id="invitees" class="form-control" multiple>
                        <% for (var i=0; i<user.friends.accepted.length; i++) { %>
                            <% if (1) { %> 
                                <option value="<%= user.friends.accepted[i].user_b %>">
                                    <%= user.friends.accepted[i].user_b %>
                                </option>
                            <% } %>
                        <% } %>
                    </select>
                </div>
                <input name="fusion_id" type="text" value="<%= fusion.id %>" hidden required>
                <button class="btn btn-default" type="submit">Add</button>
            </form>
        </div>
    </body>

    <script>
        var current = moment();
        setDate(current, "month");

        const g = new scatterPlot("graph-container", 
            ds.getPoints("month", moment(current)), 
            ds.getOptions("month", moment(current))
        );

        $('#graphs_added').chosen({
                width: '100%',
                placeholder_text_multiple: 'Select your graphs',
                search_contains: true,
        });

        $('#invitees').chosen({
            width: '100%',
            placeholder_text_multiple: 'Select friends to invite',
            search_contains: true,
        });

        // var socket = io();

    </script>

    <script>
        $(document).ready(function() {
            $(window).resize(function() {
                g.update();
            });

            /*
                On click event for changing time modes
            */
            $('.btn-graph-time').on('click', function() {
                $('.btn-graph-time').removeClass('active');
                $(this).addClass('active');
                var mode = $(this).html().toLowerCase();

                setDate(current, mode);
                g.update(
                    ds.getPoints(mode, moment(current)),
                    ds.getOptions(mode, moment(current))
                );
            }); 

            /*
                On click event for changing time
            */
            $('.date button').on('click', function() {
                var mode = $(".btn-graph-time.active").html().toLowerCase();
                var direction = $(this).attr("id");
                current = updateTime(moment(current), mode, direction);

                setDate(current, mode);
                g.update(
                    ds.getPoints(mode, moment(current)),
                    ds.getOptions(mode, moment(current))
                );
            });

            /*
                On click event for adding a new graph to the fusion
            */
            $('#add-fusion-graph').on('click', function() {
                $('.mask').addClass('active');
                $('#add-graph-form').addClass('active');
            });

            /*
                http://stackoverflow.com/questions/10318575/jquery-search-as-you-type-with-ajax
            */
            // var timeoutID = null;

            // function getGraphsBeginsWith(begin) {
            //     $.ajax({
            //         url: window.location.origin + '/graph/search/' + 'be',
            //         dataType: 'json',
            //         success: function(data) {
            //             console.log(data);
            //         },
            //     });
            // }

            // $('#graphs_added').keyup(function(e) {
            //     clearTimeout(timeoutID);
            //     console.log(e);
            //     timeoutID = setTimeout(getGraphsBeginsWith.bind(undefined, e.target.value), 500);
            // });

            /*
                On click event for inviting friend to the fusion
            */
            $('#invite-fusion').on('click', function() {
                $('.mask').addClass('active');
                $('#invite-friend-form').addClass('active');
            });

            $('.mask, .remove-mask-overlay').on('click', function() {
                $('.mask, .mask-overlay').removeClass('active');
            });
        });

        /*
            TODO: Disable scrolling!
            http://stackoverflow.com/questions/3656592/how-to-programmatically-disable-page-scrolling-with-jquery
        */
    </script>

</html>  